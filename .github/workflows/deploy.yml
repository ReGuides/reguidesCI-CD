name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit
    
    - name: Run tests
      run: npm test
      continue-on-error: true
    
    - name: Build project
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_TELEMETRY_DISABLED: 1
    
    - name: Create build archive
      run: |
        tar -czf build.tar.gz .next package.json package-lock.json public src/lib/config.ts ecosystem.config.js cleanup-backups.sh
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: build.tar.gz
        retention-days: 1

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    - name: Check build file
      run: |
        ls -la build.tar.gz
        file build.tar.gz
        du -h build.tar.gz
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    - name: Test SSH connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "SSH connection successful!"
          ls -la /var/www/reguides || echo "Directory does not exist"
          whoami
          pwd
    
    # –ü–µ—Ä–µ–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
    - name: Upload build to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          mkdir -p /var/www/reguides
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
          pm2 stop reguides-nextjs 2>/dev/null || true
          
          # –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          if [ -d "/var/www/reguides/.next" ]; then
            mv /var/www/reguides/.next /var/www/reguides/.next.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # –£–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ –±–µ–∫–∞–ø—ã
          cd /var/www/reguides
          echo "Current backups:"
          ls -la .next.backup.* 2>/dev/null || echo "No backups found"
          echo "Removing ALL old backups:"
          rm -rf .next.backup.* 2>/dev/null || echo "No backups to remove"
          echo "All backups removed"
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
          rm -rf /var/www/reguides/.next
          rm -f /var/www/reguides/package-lock.json
          
          echo "Ready for file upload"
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ scp —Å retry
    - name: Copy build file to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "build.tar.gz"
        target: "/var/www/reguides/"
        debug: true
        overwrite: true
        timeout: 300
        command_timeout: 300
        port: 22
    
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ SSH (–µ—Å–ª–∏ scp –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    - name: Upload build via SSH (fallback)
      uses: appleboy/ssh-action@v1.0.3
      if: failure()
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /var/www/reguides
          echo "Fallback upload method - using rsync instead"
          # –≠—Ç–æ—Ç —à–∞–≥ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ scp –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
    
    # –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /var/www/reguides
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
          pm2 stop reguides-nextjs 2>/dev/null || true
          
          # –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          if [ -d ".next" ]; then
            mv .next .next.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # –£–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ –±–µ–∫–∞–ø—ã
          echo "Current backups:"
          ls -la .next.backup.* 2>/dev/null || echo "No backups found"
          echo "Removing ALL old backups:"
          rm -rf .next.backup.* 2>/dev/null || echo "No backups to remove"
          echo "All backups removed"
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
          rm -rf .next
          rm -f package-lock.json
          
          # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –±–∏–ª–¥
          tar -xzf build.tar.gz
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          npm ci --only=production --prefer-offline --no-audit
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          pm2 start ecosystem.config.js --env production
          
          # –û—á–∏—â–∞–µ–º –∞—Ä—Ö–∏–≤
          rm -f build.tar.gz
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          echo "Cleaning up old build archives:"
          ls -la build.tar.gz.* 2>/dev/null | head -n -2 | awk '{print $9}' | xargs -r rm -f
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏
          chmod +x cleanup-backups.sh
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –í–°–ï –±—ç–∫–∞–ø—ã
          echo "üßπ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±—ç–∫–∞–ø–æ–≤..."
          ./cleanup-backups.sh
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"