#!/bin/bash

# –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤
# –û—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ 2 —Å–∞–º—ã—Ö –Ω–æ–≤—ã—Ö –±–µ–∫–∞–ø–∞

echo "üö® –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ë–ï–ö–ê–ü–û–í"
echo "================================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/reguides || { echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/reguides –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"; exit 1; }

echo "üìÅ –¢–µ–∫—É—â–∏–µ –±–µ–∫–∞–ø—ã:"
ls -la .next.backup.* 2>/dev/null || { echo "   –ë–µ–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"; exit 0; }

# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ–∫–∞–ø–æ–≤
backup_count=$(ls -1 .next.backup.* 2>/dev/null | wc -l)
echo "üìä –í—Å–µ–≥–æ –±–µ–∫–∞–ø–æ–≤: $backup_count"

if [ "$backup_count" -le 2 ]; then
    echo "‚ÑπÔ∏è  –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ–∫–∞–ø–æ–≤ ($backup_count) –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç (2)"
    echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
    exit 0
fi

echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ $((backup_count - 2)) —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤!"
echo "   –û—Å—Ç–∞–Ω—É—Ç—Å—è —Ç–æ–ª—å–∫–æ 2 —Å–∞–º—ã—Ö –Ω–æ–≤—ã—Ö –±–µ–∫–∞–ø–∞"
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–∏–µ –±–µ–∫–∞–ø—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è
echo "üìã –ë–µ–∫–∞–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ –û–°–¢–ê–ù–£–¢–°–Ø (2 —Å–∞–º—ã—Ö –Ω–æ–≤—ã—Ö):"
ls -t .next.backup.* 2>/dev/null | head -2 | while read backup; do
    echo "   ‚úÖ $backup"
done

echo ""
echo "üóëÔ∏è  –ë–µ–∫–∞–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –£–î–ê–õ–ï–ù–´:"
ls -t .next.backup.* 2>/dev/null | tail -n +3 | while read backup; do
    echo "   ‚ùå $backup"
done

echo ""
read -p "ü§î –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ? (y/N): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 0
fi

echo ""
echo "üóëÔ∏è  –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±–µ–∫–∞–ø—ã..."

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±–µ–∫–∞–ø—ã
deleted_count=0
ls -t .next.backup.* 2>/dev/null | tail -n +3 | while read backup; do
    echo "   –£–¥–∞–ª—è–µ–º: $backup"
    rm -rf "$backup"
    ((deleted_count++))
done

echo ""
echo "‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo ""
echo "üìÅ –û—Å—Ç–∞–≤—à–∏–µ—Å—è –±–µ–∫–∞–ø—ã:"
ls -la .next.backup.* 2>/dev/null || echo "   –ë–µ–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
echo ""
echo "üíæ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ:"
du -sh /var/www/reguides

echo ""
echo "üéâ –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "   –¢–µ–ø–µ—Ä—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ç–æ–ª—å–∫–æ 2 –±–µ–∫–∞–ø–∞"
echo "   –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–µ–ø–ª–æ—è—Ö –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞"
