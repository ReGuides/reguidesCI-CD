# Защита от потери данных при переключении вкладок

## Обзор

Система защиты от потери данных предотвращает случайную потерю несохраненных изменений при переключении между вкладками на странице персонажа.

## Проблема

Раньше пользователи могли потерять все несохраненные данные при случайном переходе на другую вкладку, что вызывало разочарование и потерю времени.

## Решение

### 1. **Отслеживание изменений**
- Каждая вкладка отслеживает свои данные
- Сравнивает текущие данные с последними сохраненными
- Показывает индикатор несохраненных изменений

### 2. **Предупреждение при переключении**
- При попытке перехода с несохраненными данными показывается модальное окно
- Пользователь может выбрать: сохранить, отменить изменения или продолжить редактирование

### 3. **Визуальные индикаторы**
- Иконка предупреждения (⚠️) на вкладках с несохраненными изменениями
- Цветовое выделение активной вкладки

## Компоненты

### 1. **useTabState Hook**
```typescript
// src/hooks/useTabState.ts
interface TabState {
  hasUnsavedChanges: boolean;
  lastSavedData: any;
  currentData: any;
}

const {
  tabStates,
  setTabData,
  markTabAsSaved,
  hasUnsavedChanges,
  hasAnyUnsavedChanges,
  confirmTabChange
} = useTabState();
```

**Функции:**
- `setTabData(tabId, data)` - устанавливает данные вкладки
- `markTabAsSaved(tabId)` - отмечает вкладку как сохраненную
- `hasUnsavedChanges(tabId)` - проверяет наличие несохраненных изменений
- `confirmTabChange(newTabId)` - подтверждает переключение вкладки

### 2. **UnsavedChangesWarning Component**
```typescript
// src/components/ui/unsaved-changes-warning.tsx
<UnsavedChangesWarning
  isVisible={showUnsavedWarning}
  onSave={handleSaveAndContinue}
  onDiscard={handleDiscardChanges}
  onCancel={handleCancelTabChange}
  tabName="Таланты"
/>
```

**Кнопки:**
- **Сохранить** - сохраняет изменения и переходит на новую вкладку
- **Отменить** - отменяет изменения и переходит на новую вкладку
- **Продолжить редактирование** - остается на текущей вкладке

### 3. **Интеграция в CharacterDetailPage**
```typescript
// src/app/characters/[id]/page.tsx
const handleTabChange = (newTab: TabType) => {
  if (hasUnsavedChanges(activeTab)) {
    setPendingTabChange(newTab);
    setShowUnsavedWarning(true);
  } else {
    setActiveTab(newTab);
  }
};
```

## Как это работает

### 1. **Отслеживание данных**
```typescript
// При загрузке данных вкладки
<CharacterTalentsSection 
  characterId={character.id}
  onDataChange={(data) => setTabData('talents', data)}
  onDataSaved={() => markTabAsSaved('talents')}
/>
```

### 2. **Проверка изменений**
```typescript
// При попытке переключения
if (hasUnsavedChanges(activeTab)) {
  // Показываем предупреждение
  setShowUnsavedWarning(true);
} else {
  // Переключаемся сразу
  setActiveTab(newTab);
}
```

### 3. **Обработка выбора пользователя**
```typescript
const handleSaveAndContinue = () => {
  markTabAsSaved(activeTab);
  setShowUnsavedWarning(false);
  if (pendingTabChange) {
    setActiveTab(pendingTabChange);
    setPendingTabChange(null);
  }
};
```

## Вкладки с защитой

### 1. **Рекомендации (weapons)**
- Отслеживает изменения в рекомендациях по оружию и артефактам
- Показывает индикатор при несохраненных изменениях

### 2. **Команды (teams)**
- Отслеживает изменения в составе команд
- Защищает от потери настроек команд

### 3. **Сборки (builds)**
- Отслеживает изменения в детальных сборках
- Защищает сложные настройки персонажей

### 4. **Таланты (talents)**
- Отслеживает изменения в приоритетах талантов
- Защищает от потери настроек прокачки

### 5. **Созвездия (constellations)**
- Отслеживает изменения в приоритетах созвездий
- Защищает от потери стратегий развития

## Визуальные индикаторы

### 1. **Иконка предупреждения**
```typescript
{hasUnsavedChanges('talents') && (
  <AlertTriangle className="w-4 h-4 text-yellow-400" />
)}
```

### 2. **Стили вкладок**
- **Активная вкладка:** Фиолетовый фон с белым текстом
- **Вкладка с изменениями:** Иконка предупреждения справа
- **Обычная вкладка:** Серый фон с серым текстом

## API интеграция

### 1. **Отправка данных**
```typescript
// При изменении данных
onDataChange?.(newData);

// При сохранении
onDataSaved?.();
```

### 2. **Получение данных**
```typescript
// При загрузке данных
setTabData('talents', data);
```

## Расширение функционала

### 1. **Автосохранение**
```typescript
// Можно добавить автоматическое сохранение каждые N секунд
useEffect(() => {
  const interval = setInterval(() => {
    if (hasUnsavedChanges(activeTab)) {
      // Автоматически сохраняем
      handleAutoSave();
    }
  }, 30000); // 30 секунд

  return () => clearInterval(interval);
}, [activeTab, hasUnsavedChanges]);
```

### 2. **Локальное хранение**
```typescript
// Можно добавить сохранение в localStorage
const saveToLocalStorage = (tabId: string, data: any) => {
  localStorage.setItem(`tab_${tabId}_${characterId}`, JSON.stringify(data));
};
```

### 3. **Восстановление данных**
```typescript
// При загрузке страницы восстанавливаем несохраненные данные
useEffect(() => {
  const savedData = localStorage.getItem(`tab_${activeTab}_${characterId}`);
  if (savedData) {
    const data = JSON.parse(savedData);
    setTabData(activeTab, data);
  }
}, [activeTab, characterId]);
```

## Тестирование

### 1. **Сценарий 1: Переключение без изменений**
1. Откройте страницу персонажа
2. Переключитесь между вкладками
3. **Ожидаемый результат:** Переключение происходит сразу

### 2. **Сценарий 2: Переключение с изменениями**
1. Откройте вкладку "Таланты"
2. Внесите изменения (не сохраняйте)
3. Попробуйте перейти на другую вкладку
4. **Ожидаемый результат:** Появляется предупреждение

### 3. **Сценарий 3: Сохранение изменений**
1. В предупреждении нажмите "Сохранить"
2. **Ожидаемый результат:** Переход на новую вкладку

### 4. **Сценарий 4: Отмена изменений**
1. В предупреждении нажмите "Отменить"
2. **Ожидаемый результат:** Переход на новую вкладку, изменения потеряны

### 5. **Сценарий 5: Продолжение редактирования**
1. В предупреждении нажмите "Продолжить редактирование"
2. **Ожидаемый результат:** Остаетесь на текущей вкладке

## Преимущества

### 1. **Защита от потери данных**
- Пользователи не теряют несохраненные изменения
- Улучшенный пользовательский опыт

### 2. **Визуальная обратная связь**
- Понятные индикаторы состояния
- Предупреждения перед опасными действиями

### 3. **Гибкость управления**
- Пользователь сам решает, что делать с изменениями
- Возможность отменить или сохранить

### 4. **Масштабируемость**
- Легко добавить новые вкладки
- Простая интеграция с существующими компонентами

## Будущие улучшения

### 1. **Умное автосохранение**
- Автоматическое сохранение при паузе в редактировании
- Восстановление данных после перезагрузки страницы

### 2. **История изменений**
- Отслеживание всех изменений
- Возможность отката к предыдущим версиям

### 3. **Синхронизация между вкладками**
- Общие данные между связанными вкладками
- Автоматическое обновление зависимых разделов

### 4. **Уведомления**
- Push-уведомления о несохраненных изменениях
- Напоминания о необходимости сохранения
