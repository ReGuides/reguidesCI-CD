# Управление бекапами

## Автоматическая очистка

Система автоматически ограничивает количество бекапов до **2 штук**. При каждом деплое:

1. Создается новый бекап текущей версии
2. Удаляются старые бекапы, оставляя только 2 последних
3. Очищаются старые архивы сборки

## Ручная очистка

### Использование скрипта очистки

На сервере доступен скрипт `cleanup-backups.sh` для ручной очистки:

```bash
# Перейти в директорию проекта
cd /var/www/reguides

# Запустить очистку
./cleanup-backups.sh
```

### Что делает скрипт:

- ✅ Показывает текущие бекапы
- ✅ Удаляет старые бекапы (оставляет только 2 последних)
- ✅ Очищает старые архивы сборки
- ✅ Показывает результат очистки

## Структура бекапов

Бекапы сохраняются в формате:
```
.next.backup.YYYYMMDD_HHMMSS
```

Пример:
```
.next.backup.20250103_125410
.next.backup.20250103_130520
```

## Мониторинг места на диске

### Проверка размера бекапов:
```bash
cd /var/www/reguides
du -sh .next.backup.*
```

### Общий размер директории:
```bash
du -sh /var/www/reguides
```

## Настройка лимита бекапов

Чтобы изменить количество сохраняемых бекапов, отредактируйте в `.github/workflows/deploy.yml`:

```bash
# Вместо tail -n +3 (оставляет 2 бекапа)
# Используйте tail -n +4 (оставляет 3 бекапа)
# Или tail -n +5 (оставляет 4 бекапа)
```

## Экстренное восстановление

### Восстановление из бекапа:
```bash
cd /var/www/reguides

# Остановить приложение
pm2 stop reguides-nextjs

# Восстановить из бекапа
rm -rf .next
mv .next.backup.YYYYMMDD_HHMMSS .next

# Запустить приложение
pm2 start ecosystem.config.js --env production
```

### Список доступных бекапов:
```bash
ls -la .next.backup.*
```

## Troubleshooting

### Если бекапы не создаются:
1. Проверьте права доступа к директории
2. Убедитесь, что директория `.next` существует
3. Проверьте логи деплоя в GitHub Actions

### Если скрипт очистки не работает:
1. Проверьте права на выполнение: `chmod +x cleanup-backups.sh`
2. Убедитесь, что находитесь в правильной директории
3. Проверьте логи выполнения скрипта

## Автоматизация

### Добавление в cron (опционально):
```bash
# Очистка бекапов каждый день в 2:00
0 2 * * * cd /var/www/reguides && ./cleanup-backups.sh
```

### Мониторинг через PM2:
```bash
# Добавить скрипт в PM2 для мониторинга
pm2 start cleanup-backups.sh --name "backup-cleanup" --cron "0 2 * * *"
```
